const PDFDocument = require("pdfkit/js/pdfkit.standalone");
const blobStream = require("../../lib/blob-stream");
const { getImageObject, setCompressedFileFields } = require("../util/FileUtils");
const { blobToBase64 } = require("../util/Base64Utils");

const convertIMGtoPDF = async (images, inputFile, callBackFunc) => {

    const pdfDocument = createPDF(inputFile);

    const stream = pdfDocument.pipe(blobStream());

    for (let image of images) {
        let imageObject = await getImageObject(image);
        pdfDocument.addPage({size: [imageObject.width, imageObject.height]});
        pdfDocument.image(imageObject.src, 0, 0);
    }

    pdfDocument.end();

    stream.on("finish", async () => {
        const outputBlob = stream.toBlob("application/pdf");
        let base64String = await blobToBase64(outputBlob);
        setCompressedFileFields(inputFile, base64String);
        callBackFunc(inputFile);
    });
}

const createPDF = (inputFile) => {
    const pdfDocument = new PDFDocument({ autoFirstPage: false, compress: false });
    const fileName = inputFile.fileName.split(".")[0];
    pdfDocument.info = {
        Title: `${fileName}.pdf`,
        Author: "mys",
        Keywords: `${fileName}, pdf`
    };
    return pdfDocument;
}

module.exports = convertIMGtoPDF;
